<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scheda — Rüs la Fiamma Ruvida</title>
<style>
:root{
  --paper:#f7ead3;
  --ink:#2b1206;
  --accent:#b84b1a;
  --muted:#7a5a47;
  --panel: #fff6e8;
  --green:#9fdc8c;
}
html,body{height:100%;margin:0;font-family: "Georgia", serif;background:linear-gradient(#efe0c8,#f9efd9);color:var(--ink);}
.container{max-width:980px;margin:18px auto;padding:18px;background:var(--paper);box-shadow:0 6px 30px rgba(0,0,0,0.12);border-radius:12px;border:2px solid rgba(160,110,60,0.12)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.title{font-size:26px;color:var(--accent);margin:0}
.subtitle{font-size:13px;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center}
.card{background:var(--panel);border-radius:8px;padding:10px;border:1px solid rgba(0,0,0,0.06);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
.left{flex:1;min-width:260px}
.right{min-width:260px}
.section{margin-top:14px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.stat{background:linear-gradient(180deg,#fff8ea,#fff2d9);padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);text-align:center;cursor:pointer}
.stat h3{margin:0;font-size:14px}
.stat .num{font-size:22px;font-weight:700}
.inline-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:white;cursor:pointer}
.big{font-size:18px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.counter{display:flex;align-items:center;gap:8px}
.spells{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.spell-card{background:#fff6e8;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);text-align:center}
.footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:40}
.modal .box{width:94%;max-width:520px;background:var(--paper);padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)}
.skill-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(0,0,0,0.02);margin-bottom:6px}
.btn-close{float:right;background:transparent;border:0;font-weight:700;cursor:pointer;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
kbd{background:#fff;padding:4px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
.tiny{font-size:12px;color:var(--muted)}
@media(max-width:720px){.grid3{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <div>
        <h1 class="title">Rüs la Fiamma Ruvida</h1>
        <div class="subtitle">Nano delle Colline — Piromante</div>
      </div>
      <div class="card right">
        <div class="small">Livello</div>
        <div class="flex" style="align-items:center">
          <button class="inline-btn" id="lvlMinus">-</button>
          <div class="big" id="lvl">6</div>
          <button class="inline-btn" id="lvlPlus">+</button>
        </div>
        <div style="height:8px"></div>
        <div class="small">Bonus competenza</div>
        <div class="flex">
          <button class="inline-btn" id="profMinus">-</button>
          <div class="big" id="prof">+3</div>
          <button class="inline-btn" id="profPlus">+</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="grid3" id="statsGrid">
        <!-- statistiche generate JS -->
      </div>
      <div class="tiny" style="margin-top:8px">Clicca su una statistica per aprire le abilità e i tiri salvezza.</div>
    </div>

    <div class="section" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <div class="card left">
        <div class="small">PF Massimi</div>
       <div class="flex">
          <button class="inline-btn" id="hpMaxMinus">-</button>
          <div class="big" id="hpMax">63</div>
          <button class="inline-btn" id="hpMaxPlus">+</button>
        </div>
        <div style="height:8px"></div>
        <div class="small">PF Attuali</div>
        <div class="flex">
          <button class="inline-btn" id="hpMinus">-</button>
          <div class="big" id="hpCur">63</div>
          <button class="inline-btn" id="hpPlus">+</button>
        </div>
        <div style="height:8px"></div>
        <div class="small">PF di Sür</div>
        <div class="flex">
          <button class="inline-btn" id="thpMinus">-</button>
          <div class="big" id="thp">34</div>
          <button class="inline-btn" id="thpPlus">+</button>
        </div>

        <div style="height:12px"></div>
        <div class="small">Classe Armatura (AC)</div>
        <div class="flex">
          <button class="inline-btn" id="acMinus">-</button>
          <div class="big" id="ac">15</div>
          <button class="inline-btn" id="acPlus">+</button>
        </div>

        <div style="height:12px"></div>
        <div class="small">Ispirazione</div>
        <div class="flex">
          <button class="inline-btn" id="inspMinus">-</button>
          <div class="big" id="insp">1</div>
          <button class="inline-btn" id="inspPlus">+</button>
        </div>

        <div style="height:12px"></div>
        <div class="small">Tiri salvezza / morte</div>
        <div class="tiny">Successi: <span id="deathSucc">0</span> • Fallimenti: <span id="deathFail">0</span></div>
        <div style="margin-top:6px" class="controls">
          <button class="inline-btn" id="deathSuccPlus">+S</button>
          <button class="inline-btn" id="deathSuccMinus">-S</button>
          <button class="inline-btn" id="deathFailPlus">+F</button>
          <button class="inline-btn" id="deathFailMinus">-F</button>
        </div>
      </div>

      <div class="card right" style="min-width:300px">
        <div class="small">Slot incantesimi</div>
        <div class="spells" id="spellSlots" style="margin-top:8px">
          <!-- slot generated by JS -->
        </div>
        <div style="height:8px"></div>
        <div class="controls" style="margin-top:10px">
          <button id="resetSlots" class="inline-btn">Reset slot</button>
          <button id="exportBtn" class="inline-btn">Esporta JSON</button>
          <button id="importBtn" class="inline-btn">Importa JSON</button>
          <input type="file" id="importFile" style="display:none" accept="application/json">
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="tiny">Salvataggio automatico locale (localStorage).</div>
      <div class="tiny">Puoi aggiungere la pagina alla schermata Home su iPhone per usarla come app.</div>
    </div>
  </div>

  <!-- MODAL TEMPLATE -->
  <div class="modal" id="modal">
    <div class="box" id="modalBox">
      <button class="btn-close" id="modalClose">Chiudi ✕</button>
      <h2 id="modalTitle"></h2>
      <div class="tiny" id="modalSub"></div>
      <hr style="margin:8px 0">
      <div id="modalContent"></div>
      <div style="height:10px"></div>
      <div style="text-align:right">
        <button id="modalSave" class="inline-btn">Chiudi</button>
      </div>
    </div>
  </div>

<script>
/* ---------- DATI INIZIALI ---------- */
const initial = {
  nome: "Rüs la Fiamma Ruvida",
  classe: "Piromante",
  livello: 6,
  profBonus: 3,
  stats: { Forza:14, Destrezza:12, Costituzione:18, Intelligenza:7, Saggezza:18, Carisma:9 },
  hpMax:63, hpCur:63, thp:34, ac:15, inspiration:1,
  slots: {1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},
  profs: {}, // object mapping skill/save keys to true
  death: {succ:0, fail:0}
};
const SAVE_KEY = "scheda_rus_v2";

/* ---------- HELPERS ---------- */
function modFromScore(s){ return Math.floor((s-10)/2); }
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
function load(){ const raw = localStorage.getItem(SAVE_KEY); if(raw) try{return JSON.parse(raw);}catch(e){} return JSON.parse(JSON.stringify(initial)); }

/* ---------- STATE ---------- */
let state = load();

/* ---------- MAPPINGS ---------- */
const skillMap = {
  Forza: ["Atletica"],
  Destrezza: ["Acrobazia","Furtività","Rapidità di Mano"],
  Costituzione: [], // no standard skills, but include save
  Intelligenza:["Arcano","Indagare","Natura","Storia","Religione"],
  Saggezza:["Medicina","Percezione","Sopravvivenza","Intuizione","Addestrare Animali"],
  Carisma:["Inganno","Intimidire","Persuasione","Intrattenere"]
};

/* ---------- RENDER ---------- */
const el = id=>document.getElementById(id);

function renderAll(){
  // header
  el("lvl").textContent = state.livello;
  el("prof").textContent = (state.profBonus>0?"+":"")+state.profBonus;

  // stats grid
  const grid = el("statsGrid"); grid.innerHTML="";
  for(const [name,val] of Object.entries(state.stats)){
    const m = modFromScore(val);
    const div = document.createElement("div");
    div.className = "stat";
    div.innerHTML = `<h3>${name}</h3><div class="num">${val}</div><div class="small">Mod ${m>=0?"+":""}${m}</div>`;
    div.onclick = ()=>openModal(name);
    grid.appendChild(div);
  }

  // hp & ac etc
  el("hpMax").textContent = state.hpMax;
  el("hpCur").textContent = state.hpCur;
  el("thp").textContent = state.thp;
  el("ac").textContent = state.ac;
  el("insp").textContent = state.inspiration;
  el("deathSucc").textContent = state.death.succ;
  el("deathFail").textContent = state.death.fail;

  // spell slots
  const slotsDiv = el("spellSlots"); slotsDiv.innerHTML="";
  for(let i=1;i<=9;i++){
    const card = document.createElement("div");
    card.className="spell-card";
    const val = state.slots[i] ?? 0;
    card.innerHTML = `<div class="small">Livello ${i}</div>
      <div class="flex" style="justify-content:center;align-items:center;margin-top:6px">
        <button class="inline-btn" data-l="${i}" data-op="-" onclick="slotChange(event)">-</button>
        <div style="width:36px;text-align:center;font-weight:700">${val}</div>
        <button class="inline-btn" data-l="${i}" data-op="+" onclick="slotChange(event)">+</button>
      </div>`;
    slotsDiv.appendChild(card);
  }

  save();
}

/* ---------- ACTIONS ---------- */
/* header controls */
el("lvlPlus").onclick = ()=>{ state.livello++; renderAll(); };
el("lvlMinus").onclick = ()=>{ state.livello = Math.max(1,state.livello-1); renderAll(); };
el("profPlus").onclick = ()=>{ state.profBonus++; renderAll(); };
el("profMinus").onclick = ()=>{ state.profBonus = Math.max(0,state.profBonus-1); renderAll(); };

/* hp */
/* hp max */
el("hpMaxPlus").onclick = ()=>{ state.hpMax++; state.hpCur = Math.min(state.hpCur, state.hpMax); renderAll(); };
el("hpMaxMinus").onclick = ()=>{ state.hpMax = Math.max(1, state.hpMax-1); state.hpCur = Math.min(state.hpCur, state.hpMax); renderAll(); };
el("hpPlus").onclick = ()=>{ state.hpCur = Math.min(state.hpMax, state.hpCur+1); renderAll(); };
el("hpMinus").onclick = ()=>{ state.hpCur = Math.max(0, state.hpCur-1); renderAll(); };
el("thpPlus").onclick = ()=>{ state.thp = state.thp+1; renderAll(); };
el("thpMinus").onclick = ()=>{ state.thp = Math.max(0,state.thp-1); renderAll(); };

/* ac & insp */
el("acPlus").onclick = ()=>{ state.ac++; renderAll(); };
el("acMinus").onclick = ()=>{ state.ac = Math.max(0,state.ac-1); renderAll(); };
el("inspPlus").onclick = ()=>{ state.inspiration++; renderAll(); };
el("inspMinus").onclick = ()=>{ state.inspiration = Math.max(0,state.inspiration-1); renderAll(); };

/* death saves */
el("deathSuccPlus").onclick = ()=>{ state.death.succ = clamp(state.death.succ+1,0,3); renderAll(); };
el("deathSuccMinus").onclick = ()=>{ state.death.succ = clamp(state.death.succ-1,0,3); renderAll(); };
el("deathFailPlus").onclick = ()=>{ state.death.fail = clamp(state.death.fail+1,0,3); renderAll(); };
el("deathFailMinus").onclick = ()=>{ state.death.fail = clamp(state.death.fail-1,0,3); renderAll(); };

/* slot change */
function slotChange(e){
  const btn = e.currentTarget;
  const lvl = Number(btn.dataset.l);
  const op = btn.dataset.op;
  if(op==="+") state.slots[lvl] = (state.slots[lvl]||0)+1;
  else state.slots[lvl] = Math.max(0,(state.slots[lvl]||0)-1);
  renderAll();
}
el("resetSlots").onclick = ()=>{
  if(confirm("Ripristinare gli slot ai valori iniziali?")){
    state.slots = Object.assign({}, initial.slots);
    renderAll();
  }
};

/* import / export */
el("exportBtn").onclick = ()=>{
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state,null,2));
  const a = document.createElement("a"); a.href=dataStr; a.download="scheda_rus.json"; document.body.appendChild(a); a.click(); a.remove();
};
el("importBtn").onclick = ()=> el("importFile").click();
el("importFile").addEventListener("change", (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ try{ const loaded = JSON.parse(reader.result); state = Object.assign({}, initial, loaded); renderAll(); alert("Import riuscito"); } catch(e){ alert("File non valido"); } };
  reader.readAsText(f);
});

/* ---------- MODAL / SKILLS ---------- */
const modal = el("modal");
const modalTitle = el("modalTitle");
const modalSub = el("modalSub");
const modalContent = el("modalContent");
const modalClose = el("modalClose");
const modalSave = el("modalSave");

function openModal(statName){
  modal.style.display = "flex";
  modalTitle.textContent = statName;
  const score = state.stats[statName];
  const base = modFromScore(score);
  modalSub.textContent = `Valore: ${score} • Modificatore: ${base>=0?"+":""}${base}`;
  // build content: Tiro salvezza + abilities
  modalContent.innerHTML = "";

  // save toggle (key: statName + "_save")
  const saveRow = document.createElement("div"); saveRow.className="skill-row";
  const saveLabel = document.createElement("div"); saveLabel.textContent = "Tiro Salvezza";
  const saveRight = document.createElement("div");
  const saveVal = computeSkillValue(statName, true);
  const saveSpan = document.createElement("span"); saveSpan.textContent = (saveVal>=0?"+":"")+saveVal; saveSpan.style.marginRight="8px";
  const saveBtn = document.createElement("button"); saveBtn.className="inline-btn";
  const keySave = `${statName}_save`;
  saveBtn.textContent = state.profs[keySave] ? "P ✓" : "Aggiungi P";
  saveBtn.dataset.key = keySave;
  saveBtn.onclick = ()=>{ toggleProf(keySave); renderModal(statName); };
  saveRight.appendChild(saveSpan); saveRight.appendChild(saveBtn);
  saveRow.appendChild(saveLabel); saveRow.appendChild(saveRight);
  modalContent.appendChild(saveRow);

  modalContent.appendChild(document.createElement("hr"));
  // abilities
  const abilities = skillMap[statName] || [];
  for(const ab of abilities){
    const row = document.createElement("div"); row.className="skill-row";
    const left = document.createElement("div"); left.textContent = ab;
    const right = document.createElement("div");
    const val = computeSkillValue(ab, false); // ab is skill name
    const valSpan = document.createElement("span"); valSpan.textContent = (val>=0?"+":"")+val; valSpan.style.marginRight="8px";
    const b = document.createElement("button"); b.className="inline-btn"; b.textContent = state.profs[ab] ? "P ✓" : "Aggiungi P";
    b.dataset.key = ab;
    b.onclick = ()=>{ toggleProf(ab); renderModal(statName); };
    right.appendChild(valSpan); right.appendChild(b);
    row.appendChild(left); row.appendChild(right);
    modalContent.appendChild(row);
  }

  // allow editing stat value
  modalContent.appendChild(document.createElement("hr"));
  const editRow = document.createElement("div"); editRow.style.marginTop="8px";
  editRow.innerHTML = `<div class="tiny">Modifica valore ${statName}: <input id="statEdit" type="number" value="${score}" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)"/> <button id="saveStatEdit" class="inline-btn">Salva</button></div>`;
  modalContent.appendChild(editRow);
  document.getElementById("saveStatEdit").onclick = ()=>{
    const v = parseInt(document.getElementById("statEdit").value) || score;
    state.stats[statName] = clamp(v,1,30);
    renderAll(); renderModal(statName);
  };
}

function renderModal(statName){
  // refresh content for open modal
  if(!modal || modal.style.display!=="flex") return;
  openModal(statName);
}

function closeModal(){ modal.style.display = "none"; }
modalClose.onclick = closeModal;
modalSave.onclick = closeModal;
modal.onclick = (e)=>{ if(e.target===modal) closeModal(); };

/* compute skill value:
   if key is save (flag true) -> statName param is statName
   if key is skill name, we need to find associated stat
*/
function computeSkillValue(key, isSave){
  if(isSave){
    const statName = key; // key is stat name for save
    const base = modFromScore(state.stats[statName]);
    const prof = state.profs[`${statName}_save`] ? state.profBonus : 0;
    return base + prof;
  } else {
    // key might be skill name; find its stat
    for(const [stat, list] of Object.entries(skillMap)){
      if(list.includes(key)){
        const base = modFromScore(state.stats[stat]);
        const prof = state.profs[key] ? state.profBonus : 0;
        return base + prof;
      }
    }
    // unknown -> return 0
    return 0;
  }
}

function toggleProf(key){
  state.profs[key] = !state.profs[key];
  save(); renderAll();
}

/* ---------- INIT ---------- */
function init(){
  // ensure all initial values exist
  state = Object.assign({}, initial, state);
  // populate missing nested fields
  state.stats = Object.assign({}, initial.stats, state.stats || {});
  state.slots = Object.assign({}, initial.slots, state.slots || {});
  state.profs = Object.assign({}, state.profs || {});
  // wire buttons already added above
  renderAll();
}
init();

/* helper to refresh modal content without recreating handlers */
function refreshModal(statName){
  if(modal.style.display !== "flex") return;
  openModal(statName);
}

/* esportiamo direttamente le funzioni globali */
window.openModal = openModal;     // <-- questo è il fix
window.slotChange = slotChange;
window.toggleProf = k => toggleProf(k);

/* keyboard shortcuts for dev (optional) */
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

</script>
</body>
</html>
